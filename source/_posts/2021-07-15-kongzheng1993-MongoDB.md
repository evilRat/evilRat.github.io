---
title: MongoDB笔记
excerpt: 'MongoDB'
tags: [MongoDB]
categories: [MongoDB]
comments: true
date: 2021-07-15 116:30:10
---

## 1. 主要特性

1. mongoDB的数据模型是面向文档的

2. 不像关系型数据库，每张表都有严格定义的Schema，规定了列和类型。mongoDB没有Schema，特别适合项目初期使用（表设计经常变化）。

3. 支持即时查询。

4. 二级索引。MongoDB中的二级索引也是用B树实现的。每个集合最多可以创建64个索引。它支持能在RDBMS中找到的各种索引，升序、降序、唯一性、复合键索引，甚至地理空间索引都支持。因为mongoDB和关系型数据库使用相同的索引数据结构。

5. 复制。mongoDB通过副本集（replica set）的拓扑结构提供了复制功能。副本集将数据分布在多台机器上以实现冗余，在服务器和网络故障时能提供自动故障转移。并且复制功能还能扩展数据库的读能力，如果有一个读密集型的应用，可以把数据库读操作分散到副本集集群中的各台机器上。**副本集由一个主节点和一个或多个从节点构成。**与我们熟悉的其他数据库的主从复制类似。副本集的主节点既能接受读操作又能接受写操作，但是从节点是只读的。**副本集与众不同的是它支持自动故障转移：如果主节点出现问题，集群会选择一个从节点自动将它提升为主节点。在先前的主节点恢复后会变成一个从节点**。

<img src = "image-20210715174420382.png"/>

6. 速度和持久性。用户可以选择写入语义，决定是否开启Journaling日志，通过这种方式来控制速度和持久性的平衡。默认所有的写操作都是`fire-and-forget`（射后不理）的，也就是通过TCP套接字发送，不要求数据库应答。如果用户需要获得应答，可以使用特殊的安全模式发起写操作，所有驱动都提供这个安全模式。该模式强制数据库做出应答，确保数据库正确无误地接收到了写操作。安全模式是可配置的，还可用于阻塞操作，直到写操作被复制到特定数量的服务器。对于高容量、低价值的数据（例如点击流和日志）,`fire-and-forget`风格的写操作是很理想的。对于重要的数据，则更倾向于安全模式。**在MongoDB 2.0中，Journaling日志是默认开启的。**有了这个功能，所有写操作都会被提交到一个只能追加的日志里。即使服务器非正常关闭（比如电源故障）,该日志也能保证重启服务器后MongoDB的数据文件被恢复到一致的状态。这是运行MongoDB最安全的方式。Journaling日志类似MySQL的InnoDB的事务日志，先写日志，再写内存，而后日志会同步到磁盘。先写日志，而不是直接去写主数据文件，是因为**顺序IO要比随机IO快的多**
7. 数据库扩展。**提升单一节点的硬件来进行扩展成为垂直扩展或者向上扩展**。垂直扩展的优势在于简单可靠，但是终有一天更强的服务器成本会让人望而却步。这时就应该考虑水平扩展或向外扩展了。**水平扩展不是提升单一节点的性能，而是将数据库分布到多台机器上**。MongoDB的水平扩展非常易于管理，通过基于范围的分区机制即**自动分片**来实现这一设计目标，自动分片机制会自动管理各个节点之间的数据分布。分片系统会处理分片节点的增加，帮助进行自动故障转移。单独的分片由一个副本集组成，其中包含至少两个节点，保证能够自动恢复，没有单点失败。

## MongoDB核心服务器

MongoDB是用C++编写的，由10gen积极维护。开源的。

1. 通过可执行文件mongod（windows上是mongodb.exe）可以运行核心服务器。mongod服务器进程使用一个自定义的二进制协议从网络套接字上接收命令，mongod进程的所有数据文件默认存储在`/data/db`里
2. mongod有多种运行模式，最常见的是作为副本集中的一员，因为推荐使用复制，通常副本集由两个副本组成，再加上一个部署在第三台服务器上的**仲裁进程**。
3. 对于MongoDB的自动分片架构而言，其组件包含配置为预先分片的副本集的mongod进程，以及特殊的元数据服务器，称为配置服务器（config server）。另外还有单独的名为mongos的路由服务器向适当的分片发送请求。
4. mongodb除了指定标准端口和数据目录，没有什么调优数据库的选项。但是这并不是缺陷，而是一个系统设计亮点，因为MongoDB的设计哲学指出，内存管理最好是由操作系统而非DBA或者应用程序开发者来处理，如此一来，数据文件通过mmap()系统调用被映射成了系统的虚拟内存，这一举措行之有效的将内存管理交给了操作系统内核。

## MongoDB工具

1. JavaScript Shell： MongoDB命令行shell是一个基于JavaScript的工具，用户管理数据库和操作数据。可执行文件mongo会加载shell并连接到指定的mongod进程。MongoDB Shell的功能和Mysql Shell差不多，但并不是使用SQL，大多数命令使用的是Javascript表达式。比如`db.users.insert({name: "Tom"})`。
2. 数据库驱动。
3. 命令行工具：
   1. mongodump和mongorestore：备份和恢复数据库的工具
   2. mongoexport和mongoimport：用来导入导出JSON、CSV和TSV数据
   3. mongosniff：一个网络嗅探工具，用来观察发送到数据库的操作。基本就是把网络上传输的BSON转换为易于人们阅读的Shell语句。
   4. mongostat：持续轮询MongoDB和系统以便提供有磅数的统计信息，包括每秒操作数、分配的虚拟内存数量以及服务器的连接数。

