---
title: Linux文件句柄
excerpt: ''
tags: [others]
categories: [others]
comments: true
date: 2020-05-12 00:30:52
---

## 什么是文件句柄

在文件I/O中，要从一个文件读取数据，应用程序首先要调用操作系统函数并传送文件名，并选一个到该文件的路径来打开文件。该函数取回一个顺序号，即**文件句柄（file handle）**。文件句柄，也叫文件描述符。**文件描述符（File Descriptor）** 是内核为了高效管理已被打开的文件所创建的索引，它是一个非负整数（通常是小整数），用于指代被打开的文件。所有的IO系统调用，包括socket的读写调用，都是通过文件描述符完成的。在Linux系统中，文件可分为：*普通文件、目录文件、链接文件和设备文件。*


## 为什么要自己设置文件句柄

Linux系统默认值为1024，也就是说，一个进程最多可以接受1024个socket连接。即使采用了最先进的模型，如果不进行合理的配置，也没有办法支撑百万级的网络连接并发。

在Linux下，通过调用`ulimit`命令，可以看到单个进程能够打开的最大文件句柄数量，这个命令的具体使用方法是：

```shell
ulimit -n
```

什么是`ulimit`命令呢？它是用来显示和修改当前用户进程一些基础限制的命令，`-n`命令选项用于引用或设置当前的文件句柄数量的限制值。Linux的系统默认值为1024。默认的数值为1024，对绝大多数应用（例如Apache、桌面应用程序）来说已经足够了。但是，是对于一些用户基数很大的**高并发**应用，则是远远不够的。一个高并发的应用，面临的并发连接数往往是十万级、百万级、千万级、甚至像腾讯QQ一样的上亿级。文件句柄数不够，会导致什么后果呢？当单个进程打开的文件句柄数量，超过了系统配置的上限值时，就会发出`Socket/File:Can't open so many files`的错误提示。对于高并发、高负载的应用，就必须要调整这个系统参数，以适应处理并发处理大量连接的应用场景。可以通过`ulimit`来设置这两个参数。方法如下：

```shell
ulimit -n 1000000
```

在上面的命令中，n的设置值越大，可以打开的文件句柄数量就越大。建议以root用户来执行此命令。然而，使用`ulimit`命令来修改当前用户进程的一些基础限制，仅在当前用户环境有效。直白地说，就是在当前的终端工具连接当前shell期间，修改是有效的；一旦断开连接，用户退出后，它的数值就又变回系统默认的1024了。也就是说，`ulimit`只能作为临时修改，系统重启后，句柄数量又会恢复为默认值。如果想永久地把设置值保存下来，可以编辑`/etc/rc.local`开机启动文件，在文件中添加如下内容：

```shell
ulimit -SHn 1000000
```

增加`-S`和`-H`两个命令选项。选项`-S`表示软性极限值，`-H`表示硬性极限值。硬性极限是实际的限制，就是最大可以是100万，不能再多了。软性极限是系统警告（Warning）的极限值，超过这个极限值，内核会发出警告。

普通用户通过`ulimit`命令，可将软极限更改到硬极限的最大设置值。如果要更改硬极限，必须拥有**root**用户权限。终极解除Linux系统的最大文件打开数量的限制，可以通过编辑Linux的极限配置文件`/etc/security/limits.conf`来解决，修改此文件，加入如下内容：

```shell
soft nofile 1000000
hard nofile 1000000
```

`soft nofile`表示软性极限，`hard nofile`表示硬性极限。

在使用和安装目前非常火的分布式搜索引擎——ElasticSearch，就必须去修改这个文件，增加最大的文件句柄数的极限值。如果mysql出现`Socket/File:Can't open so many files`的错误提示，也可以通过增加最大文件句柄数的极限值。在服务器运行Netty时，也需要去解除文件句柄数量的限制，修改/etc/security/limits.conf文件即可。