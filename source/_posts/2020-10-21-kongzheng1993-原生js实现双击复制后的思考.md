---
title: 原生js实现双击复制后的思考
excerpt: 'JavaScript'
tags: [JavaScript]
categories: [JavaScript]
comments: true
date: 2020-10-21 00:30:52
---


昨天做了一个需求 --- 把一个系统所有页面的一个重要编号（a），增加双击复制的功能。

查了一下资料，问了一个做前端的前同事，得到的结果都是： 

```js
    $$.dblClick = function (value) {
        const oInput = document.createElement('textarea')
        oInput.value = value
        oInput.select()
        if (document.execCommand('copy')) {
            Vue.prototype.$message({message: value + ' 已复制', type: 'success'})
        }
        oInput.remove()
    }
```

然后就这么实现了，而且效果也可以。

然后后面需求变动，因为有一个页面的表单里，这个编码（a）是个button，点击会弹出详情，所以要在这个button后面加一个复制的icon，点击的时候复制这个编码到剪贴板。

前面的复制到剪贴板的代码，我抽取出来成为了公共方法，一共需要修改19个页面，共同使用。

下面是增加到icon到代码：

```html
<el-tooltip class="item" effect="dark" content="点击复制" placement="right">
    <i class="el-icon-document" style="color: dodgerblue" @click="$$UF.dblClick(scope.row.a)"></i>
</el-tooltip>
```

这里到icon在点击到时候，和其他页面调用同一个方法，传入a，并且也能正常传入a。

但是诡异的事情发生了，点击icon并不能正常复制。前面所有的双击选中复制的都能正常复制。

后面debug发现，`document.execCommand('copy')`返回`true`时，复制成功，返回`false`时，不支持或者当前场景不允许使用。而点击icon时，就会返回`false`。

<img src="WechatIMG26.jpeg">

上图就可以看到，断点打在`if`，还没有执行execCommand，此时可以看到我debug之前添加的watch，exec方法返回的是`true`，但是执行了方法的前三行代码后，exec方法却要返回`false`了。

网上查资料看到，`document.execCommand`方法，有人说是因为ajax异步，有回调函数，导致作用域变了，导致这里返回`false`。有人说，有一个userAction的变量，表示用户操作，如果当前动作是用户操作的，userAction为`true`，否则为`false`，而这个userAction会影响exec方法的执行，也就是因为操作剪贴板等操作，是安全级别比较高的操作，程序必须判断当前动作是否为用户的操作来保证安全。


但是前面十几个双击复制，和这边的点解icon复制有什么不同呢，为什么结果不一样呢？

我们仔细看下代码，这方法的意思很简单，就是new一个textarea，然后把我们要复制的内容赋值给这个textarea的value，然后选中这个textarea，然后执行copy命令。

双击复制，和点击icon复制，都是把我们要保存的value传入这个方法，有什么不一样呢？？？

mmp，js真是玄学。。

经过几个同事的讨论，我认为比较靠谱的还是：

当双击的时候，我们真的会选中我们双击的内容！！！而点击icon的时候，代码里select了，却不是人为的操作，导致程序认为这不是用户操作，导致userAction被置为`false`，进而导致exec方法返回`false`，复制失败。

后面我把双击复制，修改为单击复制，exec也会返回`false`。

而且，我修改为单击后，点击无法复制成功，双击却可以复制成功，应该就双击会选中的影响。

大概可以证实上面的猜测。。

希望有大佬能在评论区指点。。


