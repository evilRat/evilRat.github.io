---
title: 主键自增的原理
excerpt: '数据库'
tags: [数据库]
categories: [数据库]
comments: true
date: 2022-06-22 18:30:52
---

我们平常使用关系行数据库，总会创建一个与业务无关的主键列ID，并且这个id是自增的。记得刚工作前两年，还在用oracle数据库，oracle的自增要靠创建一个从1开始，步长为1的序列，每次要插入数据前，先通过这个序列获取id。

后来开始用MySQL了，每次建表上来就是一个`id int not null primary key auto_increment`，知道这样我们insert数据的时候id为空或者0，就可以出发id自增。说实话一直也没仔细去了解这其中的原理，今天就好好盘一下。

## 怎么实现自增

mysql中有两个设置：自增值`auto_increment_offset`和漂移值`auto_increment_increment`（也就是步长）

```shell
mysql> show variables like 'auto_increment%';
+--------------------------+-------+
| Variable_name            | Value |
+--------------------------+-------+
| auto_increment_increment | 1     |
| auto_increment_offset    | 1     |
+--------------------------+-------+
2 rows in set (0.01 sec)
```

自增的算法：从auto_increment_offset开始，以auto_increment_increment为步长，持续增加。如果插入的id为x，当前的自增值为y：
- 如果x < y，那么这个表的自增值不变，如果x表里不存在，可以插入成功，如果存在报主键重复。
- 如果x>=y，那么需要把当前自增值修改为x

```
mysql> create table t_test(id int not null primary key auto_increment, a varchar(20) default null );
Query OK, 0 rows affected (0.04 sec)

mysql> insert into t_test(a) values ('test');
Query OK, 1 row affected (0.02 sec)

mysql> select * from t_test;
+----+------+
| id | a    |
+----+------+
|  1 | test |
+----+------+
1 row in set (0.01 sec)

mysql> insert into t_test values (3, 'test3');
Query OK, 1 row affected (0.03 sec)

mysql> select * From t_test;
+----+-------+
| id | a     |
+----+-------+
|  1 | test  |
|  3 | test3 |
+----+-------+
2 rows in set (0.00 sec)

mysql> insert into t_test(a) values ('test4');
Query OK, 1 row affected (0.02 sec)

mysql> select * From t_test;
+----+-------+
| id | a     |
+----+-------+
|  1 | test  |
|  3 | test3 |
|  4 | test4 |
+----+-------+
3 rows in set (0.00 sec)
```


https://www.jb51.net/article/221895.htm