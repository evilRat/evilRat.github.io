---
title: JVM调优
excerpt: 'JVM'
tags: [JVM]
categories: [JVM]
comments: true
date: 2021-07-04 13:30:10
---


## 为什么

1. 为什么要jvm调优？ 因为要尽量减少GC的次数
2. 为什么要减少GC？ 因为GC时会发成STW，造成所有的java代码停止运行，native代码可以运行，但是不能与JVM进行交互。
3. 为什么GC要STW，不能一起运行吗？因为程序运行会导致内存中数据的状态变化，比如根据可达性算法通过GC Root查找没有被引用的对象，开始gc的时候一个对象还不是垃圾，但是如果我们的程序依然在运行，线程结束后，栈被清空，一些堆内的对象失去了引用，就变成垃圾了，这时候如果gc线程再回去找垃圾，算法会很低效，因为数据的状态一直会变，不如直接stw，一把将所有的垃圾回收完，再恢复运行。

## 知识点

### 1. JVM

JVM被分为三个主要的子系统：类加载器子系统、运行时数据区和执行引擎 。主要研究的是运行时数据区，也就是JVM内存结构，特别注意其中Java 堆和方法区是**线程共享**的。其他都是**线程私有**的，而jvm调优主要就是调整这里面的堆

<img src='JVM.png'>

<img src='stack.png'>

Java 堆并不是单纯的一整块区域，**实际上java堆是根据对象存活时间的不同**，Java 堆还被分为年轻代、老年代两个区域，年轻代还被进一步划分为 Eden 区、From Survivor 0、To Survivor 1 区。并且默认的虚拟机配置比例是Eden：from ：to = 8:1:1 。简单来说就是：

**Java堆 = 老年代 + 新生代**

新生代 = Eden + S0 + S1

默认Eden:from:to = 8:1:1

`-Xms` 堆容量初始大小（堆包括新生代和老年代）。 例如：-Xms 20M
`-Xmx` 堆总共（最大）大小。 例如：-Xmx 30M
**注意：建议将 -Xms 和 -Xmx 设为相同值，避免每次垃圾回收完成后JVM重新分配内存！**
`-Xmn` 新生代容量大小。例如：-Xmn 10M
`-XX` SurvivorRatio` 设置参数Eden、form和to的比例 【比例参数Eden、form和to默认是8:1:1】例如：-XX： SurvivorRatio=8 代表比例8:1:1

虽然没有直接设置老年代的参数，但是可以设置堆空间大小和新生代空间大小两个参数来间接控制：
**老年代空间大小 = 堆空间大小 - 年轻代大空间大小**

当我们的 Java 堆内有足够的空间去完成实例分配时，并且堆也无法扩展，将会抛出我们常见的**OutOfMemoryError** 异常，也就是我们常说的**OOM** 异常

### 2. JVM新生代8:1:1的原因

统计学测算出当内存使用超过98%以上时，内存就应该被minor gc时回收一次。但是实际应用中，我们不能较真的只给 他们留下2%，换句话说当内存使用达到98%时才GC 就有点晚了，应该是多一些预留10%内存空间，这预留下来的空间我们称为S区（有两个s区s1和s0），S区是用来存储新生代GC后存活下来的对象，而我们知道新生代GC算法使用的是复制回收算法。

所以我们实际GC发生是在，新生代内存使用达到90%时开始进行，复制存活的对象到S1区，要知道GC结束后在S1区活下来的对象，在下一次GC的范围是，eden区和S1，把这两部分存活的对象放入S0区，如此反复，下一次GC范围是eden区和S0区，一句话每次GC范围是eden区+一个S区。（比例是，eden：s1:s0=80%:10%:10%=8:1:1）这里的eden区（80%） 和其中的一个  S区（10%） 合起来共占据90%，GC就是清理的他们，始终保持着其中一个S区是空留的，保证GC的时候复制存活的对象有个存储的地方。

**这样的好处是什么？**

高效！！！GC 算法总体就是三种：1 复制 2 标记 3标记整理，垃圾回收算法将这几种选择起来相互组合。毫无疑问，只存在少量存活的对象，只需复制少量存活的对象，远远比标记和标记整理高效多。

**如何判断对象存活可用？**

可达性分析法来判断:通过一系列称为`GCRoot`对象做起点，从这些节点向下搜索，搜索所走过的路径称为引用链，如果一个对象在引用链上，就说是可达的，这种对象就是需要存活下来的。

**作为GC Roots的对象包括下面几种：**

1. 当前虚拟机栈中局部变量表中的引用的对象

2. 当前本地方法栈中局部变量表中的引用的对象

3. 方法区中类静态属性引用的对象

4. 方法区中的常量引用的对象

**设置Survivor区是为了减少送到老年代的对象**

