---
title: 一次服务器告警的处理
excerpt: ''
tags: [Ohters]]
categories: [Ohters]
comments: true
date: 2020-04-30 00:30:52
---

## 一次服务器告警的处理

今天客户在群里一阵@我，说是收到服务器告警短信了。

```
Usage disk is more than 90% on volume /home...
```

磁盘空间告急啊。

### 分析

这台机器上部署了应用和MySQL，日志文件和数据库文件应该是存储的大头，所以立即锁定目标。

为了不泄漏公司机密，以下数据都是我本地的，**有内味就行了**

我迅速连上公司vpn，ssh到目标主机。

```shell
test@Evil:~$ df -h
Filesystem      Size  Used Avail Use% Mounted on
rootfs           59G   51G  7.7G  87% /
none             59G   51G  7.7G  87% /dev
none             59G   55G  7.7G  92% /home
...
```

可以看到`/home`目录果然超过90%。

```shell
test@Evil:~$ du -h -d 1 *
37G    Mysql
12G    logs/xxx
12G    logs
...
```

查看/home目录下文件的大小，可以看到确实是Mysql和logs占了使用空间的大头。。

### 清理应用日志

日志文件好整，我获得了客户的授权，一波删除带走

```shell
rm -rf logs/xxx/xx-2019-*.log
```

去年的日志一波带走

```shell
test@Evil:~$ du -h -d 1 *
37G    Mysql
2G    logs/xxx
2G    logs
...
```

看到回了口血，一阵欣慰，毕竟在生产`rm -rf`的机会不多。。

### mysql binlog

接下来就是搞Mysql了

我知道，它占用空间的大头，也就是数据库文件和binlog文件了，binlog好搞，先易后难。

因为是单点的mysql，所以不用担心什么主备同步问题，带走。。

```shell
mysql> reset master; # 清空所有 binlog 文件
```

### mysql ibdata1

mysql的数据文件，我真的是头疼，上次处理相似问题的时候，跟公司的dba讨论了以下，好像是得先导出数据，然后删除ibdata1文件，再启动mysql，导入数据。

**大白天的怎么能干这种事儿呢？**

只能先分析一波了。

ibdata1是啥呢？

当你启用了 innodb_file_per_table，表被存储在他们自己的表空间里，但是共享表空间仍然在存储其它的 InnoDB 内部数据：

- 数据字典，也就是 InnoDB 表的元数据
- 变更缓冲区
- 双写缓冲区
- 撤销日志




